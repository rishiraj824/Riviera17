var Vec3=function(){function a(a,b,c){this.set(a||0,b||0,c)}return a.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c||0,this},a.tmp=function(b,c,d){return a.tmpA.set(b,c,d),a.tmpA},a.prototype.copy=function(a){return this.set(a.x,a.y,a.z),this},a.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},a.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},a.prototype.mul=function(a){return this.x*=a.x,this.y*=a.y,this.z*=a.z,this},a.prototype.invert=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},a.prototype.mulf=function(a){return this.x*=a,this.y*=a,this.z*=a,this},a.prototype.divf=function(a){return this.x/=a,this.y/=a,this.z/=a,this},a.prototype.clamp=function(a,b){return this.x=Math.min(b,Math.max(a,this.x)),this.y=Math.min(b,Math.max(a,this.y)),this.z=Math.min(b,Math.max(a,this.z)),this},a.prototype.normalize=function(){var a=this.mag();if(a>Consts.EPSILON){var b=1/a;this.x*=b,this.y*=b,this.z*=b}return this},a.prototype.mag=function(){return Math.sqrt(this.sqr_mag())},a.prototype.sqr_mag=function(){return this.x*this.x+this.y*this.y+this.z*this.z},a.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},a.cross=function(a,b,c){c.x=a.y*b.z-a.z*b.y,c.y=a.z*b.x-a.x*b.z,c.z=a.x*b.y-a.y*b.x},a.min=function(a,b,c){c.x=a.x<b.x?a.x:b.x,c.y=a.y<b.y?a.y:b.y,c.z=a.z<b.z?a.z:b.z},a.max=function(a,b,c){c.x=a.x>b.x?a.x:b.x,c.y=a.y>b.y?a.y:b.y,c.z=a.z>b.z?a.z:b.z},a.lerp=function(a,b,c,d,e){e=e||Easing.lerp,a.x=e(b.x,c.x,d),a.y=e(b.y,c.y,d),a.z=e(b.z,c.z,d)},a.prototype.toString=function(){return"X: "+this.x+" Y: "+this.y+" Z: "+this.z},a._TMP=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a.tmpD=new a,a}(),AABB=function(){function a(a,b){return this.min=new Vec3,this.max=new Vec3,this.set(a||this.min,b||this.max),this}return a.prototype.copy=function(a){return this.min.copy(a.min),this.max.copy(a.max),this},a.prototype.set=function(a,b){return this.min.copy(a),this.max.copy(b),this},a.prototype.setf=function(a,b,c){return this.min.x=-a/2,this.max.x=a/2,this.min.y=0,this.max.y=b,this.min.z=-c/2,this.max.z=c/2,this},a.prototype.overlaps=function(a,b,c){var d=this.width()/2,e=a.width()/2,f=Math.abs(c.x-b.x);return f>d+e?!1:(d=this.height()/2,e=a.height()/2,f=Math.abs(c.y-b.y),f>d+e?!1:(d=this.depth()/2,e=a.depth()/2,f=Math.abs(c.z-b.z),f>d+e?!1:!0))},a.prototype.contains=function(a){var b=this;return a.min.x>=b.min.x&&a.max.x<=b.max.x&&a.min.y>=b.min.y&&a.max.y<=b.max.y&&a.min.z>=b.min.z&&a.max.z<=b.max.z},a.prototype.center=function(a){var b=this.min,c=this.max;return a.x=(b.x+c.x)/2,a.y=(b.y+c.y)/2,a.z=(b.z+c.z)/2,this},a.prototype.width=function(){return this.max.x-this.min.x},a.prototype.height=function(){return this.max.y-this.min.y},a.prototype.depth=function(){return this.max.z-this.min.z},a.prototype.mul_matrix=function(a){function b(b,f,g){a.mul_point(e.set(b,f,g)),e.x<c.x&&(c.x=e.x),e.y<c.y&&(c.y=e.y),e.z<c.z&&(c.z=e.z),e.x>d.x&&(d.x=e.x),e.y>d.y&&(d.y=e.y),e.z>d.z&&(d.z=e.z)}var c=Vec3.tmpA.copy(this.min),d=Vec3.tmpB.copy(this.max),e=Vec3.tmpC,f=this.min,g=this.max;return a.mul_point(c),a.mul_point(d),b(f.x,g.y,f.z),b(g.x,g.y,f.z),b(g.x,f.y,f.z),b(f.x,f.y,g.z),b(f.x,g.y,g.z),b(g.x,f.y,g.z),this.set(c,d)},a.combine=function(a,b,c){Vec3.min(a.min,b.min,c.min),Vec3.max(a.max,b.max,c.max)},a._TMP=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a.tmpD=new a,a}(),Ajax=function(){function a(){}return a.prototype.create_request=function(a){return a.XMLHttpRequest?new XMLHttpRequest:a.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):void 0},a.prototype.handle_response=function(a,b,c){a.onreadystatechange=function(){4==a.readyState&&(200==a.status?b(a.responseText):c(a.statusText))}},a.prototype.get=function(a,b,c,d,e){var f=this.create_request(window);c&&f.overrideMimeType(c),this.handle_response(f,d,e),f.open("GET",a,!0),f.send()},a}(),PixelType;!function(a){a[a.COLOR=0]="COLOR",a[a.DEPTH=1]="DEPTH",a[a.STENCIL=2]="STENCIL"}(PixelType||(PixelType={}));var Camera=function(){function a(){return this.entity=new Entity,this.projection=new Mat4,this.view=new Mat4,this.view_projection=new Mat4,this.color=new Color(0,0,0,0),this.clear_mode=0,this.depth=0,this.mask=0,this.render_targets=[],this.overlay=new Entity,this.dirty=!0,this.aspect=1,this.near=.1,this.far=100,this.fov=60,this}return a.prototype.ortho=function(a,b){var c=onyx.view.width,d=onyx.view.height;return this.near=a,this.far=b,this.aspect=c/d,this.overlay.mesh=MeshTools.quad(2,2),this.overlay.material=new Material(Shader.find("overlay")),this.update_projection=this.update_ortho,this.render_targets.push(new RenderTarget(0,0,c,d,0)),this},a.prototype.perspective=function(a,b,c){var d=onyx.view.width,e=onyx.view.height;return this.fov=a,this.near=b,this.far=c,this.aspect=d/e,this.overlay.mesh=MeshTools.quad(2,2),this.overlay.material=new Material(Shader.find("overlay")),this.update_projection=this.update_perspective,this.render_targets.push(new RenderTarget(0,0,d,e,0)),this},a.prototype.set_fov=function(a){this.fov=a,this.dirty=!0},a.prototype.set_clipping=function(a,b){this.near=a,this.far=b,this.dirty=!0},a.prototype.set_aspect=function(a){this.aspect=a,this.dirty=!0},a.prototype.update_ortho=function(){var a=this.projection.identity().m;a[0]=2/onyx.view.width,a[5]=2/onyx.view.height,a[10]=-2/(this.far-this.near),a[14]=0,a[15]=1},a.prototype.update_perspective=function(){var a=this.projection.identity().m,b=1/Math.tan(this.fov*Consts.PI_OVER_360),c=this.near,d=this.far,e=c-d,f=this.aspect;a[0]=b/f,a[5]=b,a[10]=(d+c)/e,a[11]=-1,a[14]=2*c*d/e,a[15]=0},a.prototype.update_projection=function(){},a.prototype.update_transform=function(){this.dirty&&this.update_projection(),this.entity.update_transform(),this.dirty=!1,this.view.copy(this.entity.matrix).invert(),this.view_projection.copy(this.view).mul(this.projection)},a.prototype.render=function(a){this.overlay.material.bind();var b=this.render_targets[0];this.overlay.material.set_texture("texture",b.texture,0),this.overlay.render(a,this),this.overlay.material.unbind()},a.prototype.world_to_screen=function(a,b){b.copy(a),this.view_projection.mul_projection(b),b.x=(b.x+1)/2*onyx.view.width,b.y=(1-b.y)/2*onyx.view.height},a.prototype.screen_to_view=function(a,b){b.x=a.x/onyx.view.width,b.y=1-a.y/onyx.view.height,b.z=a.z},a.prototype.screen_to_world=function(a,b){b.x=2*a.x/onyx.view.width-1,b.y=-2*a.y/onyx.view.height+1,b.z=a.z;var c=Mat4.tmpA.copy(this.view_projection).invert();c.mul_projection(b)},a}(),Color=function(){function a(a,b,c,d){this.set(a||0,b||0,c||0,d||0)}return a.prototype.set=function(a,b,c,d){return this.r=a,this.g=b,this.b=c,this.a=d,this},a.prototype.copy=function(a){return this.set(a.r,a.g,a.b,a.a),this},a.lerp=function(a,b,c,d,e){e=e||Easing.lerp,a.r=e(b.r,c.r,d),a.g=e(b.g,c.g,d),a.b=e(b.b,c.b,d),a.a=e(b.a,c.a,d)},a.tmp=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a.white=new a(1,1,1,1),a.red=new a(1,0,0,1),a.blue=new a(0,0,1,1),a.yellow=new a(1,1,0,1),a.green=new a(0,1,0,1),a}(),Consts=function(){function a(){}return a.E=2.718281828459045,a.PI=3.141592653589793,a.TAU=2*a.PI,a.DEG2RAD=a.PI/180,a.RAD2DEG=57.2957795,a.PI_OVER_360=a.PI/360,a.EPSILON=2.220446049250313e-16,a}(),Debug=function(){function a(a){this.context=a,this.frame_time=0,this.frame_count=0,this.overlay=document.createElement("div"),this.overlay.classList.add("overlay"),a.container.appendChild(this.overlay),this.fps=new UILabel("FPS",["fps"]),this.add_element(this.fps),this.logger=new UILabel("LOG",["logger"]),this.add_element(this.logger)}return a.prototype.log=function(a){this.logger.set(a.toString())},a.prototype.update=function(a){if(this.frame_count+=1,this.frame_time+=a,this.frame_count>10){var b=(this.frame_count/this.frame_time).toFixed(2);this.frame_time=0,this.frame_count=0,this.fps.set(b.toString())}},a.prototype.add_element=function(a){this.overlay.appendChild(a.container)},a.prototype.toggle_overlay=function(){this.overlay.classList.toggle("hidden")},a}(),UILabel=function(){function a(a,b){if(this.container=document.createElement("div"),this.container.classList.add("label"),b)for(var c=b.length,d=0;c>d;++d)this.container.classList.add(b[d]);return this.set(a),this}return a.prototype.set=function(a){this.container.innerHTML=a},a}(),UIGroup=function(){function a(a){this.children=[],this.container=document.createElement("div"),this.container.classList.add("uigroup"),this.label=new UILabel(a,["h1"]);var b=this;this.label.container.onclick=function(){b.toggle(b)},this.container.appendChild(this.label.container)}return a.prototype.toggle=function(a){for(var b=a.children.length,c=0;b>c;++c)a.children[c].container.classList.toggle("hidden")},a.prototype.clear=function(){this.container.removeChild(this.label.container),this.label=null;for(var a=this.children.length,b=0;a>b;++b){var c=this.children[b];this.container.removeChild(c.container),c=null}this.children=[]},a.prototype.add_child=function(a){this.children.push(a),this.container.appendChild(a.container)},a.prototype.update=function(){for(var a=this.children.length,b=0;a>b;++b)this.children[b].update()},a}(),UISlider=function(){function a(a,b,c,d,e){if(this.container=document.createElement("div"),this.container.classList.add("slider"),a){var f=new UILabel(a,["h3"]);this.container.appendChild(f.container)}var g=document.createElement("input");g.id=a,g.type="range",g.min=b.toString(),g.max=c.toString(),g.step=d.toString(),g.value=e.toString(),g.classList.add("control"),this.container.appendChild(g);var h=new UILabel(e.toString(),["h3"]);return this.container.appendChild(h.container),this.control=g,this.indicator=h,this.value=e,this}return a.prototype.update=function(){this.indicator.set(this.value.toString()),this.value=this.control.value},a}(),UICheckbox=function(){function a(a,b){if(this.container=document.createElement("div"),this.container.classList.add("vector"),a){var c=new UILabel(a);this.container.appendChild(c.container)}var d=document.createElement("input");return d.id=a,d.type="checkbox",d.value=b.toString(),d.classList.add("control"),this.container.appendChild(d),this.control=d,this.value=b,this}return a.prototype.update=function(){this.value=this.control.value},a}(),UIVec2Field=function(){function a(a,b,c,d,e){if(this.value=new Vec3,this.container=document.createElement("div"),this.container.classList.add("vector"),a){var f=new UILabel(a,["h2"]);this.container.appendChild(f.container)}this.x=new UISlider("X",b,c,d,e.x),this.y=new UISlider("Y",b,c,d,e.y),this.container.appendChild(this.x.container),this.container.appendChild(this.y.container),this.value.copy(e)}return a.prototype.update=function(){this.x.update(),this.y.update(),this.value.set(this.x.value,this.y.value)},a}(),UIVec3Field=function(){function a(a,b,c,d,e){if(this.value=new Vec3,this.container=document.createElement("div"),this.container.classList.add("vector"),a){var f=new UILabel(a,["t2"]);this.container.appendChild(f.container)}this.x=new UISlider("X",b,c,d,e.x),this.y=new UISlider("Y",b,c,d,e.y),this.z=new UISlider("Z",b,c,d,e.z),this.container.appendChild(this.x.container),this.container.appendChild(this.y.container),this.container.appendChild(this.z.container),this.value.copy(e)}return a.prototype.update=function(){this.x.update(),this.y.update(),this.z.update(),this.value.set(this.x.value,this.y.value,this.z.value)},a}(),UIColorField=function(){function a(a,b,c,d,e){if(this.value=new Color,this.container=document.createElement("div"),this.container.classList.add("vector"),a){var f=new UILabel(a,["h2"]);this.container.appendChild(f.container)}this.r=new UISlider("R",b,c,d,e.r),this.g=new UISlider("G",b,c,d,e.g),this.b=new UISlider("B",b,c,d,e.b),this.a=new UISlider("B",b,c,d,e.a),this.container.appendChild(this.r.container),this.container.appendChild(this.g.container),this.container.appendChild(this.b.container),this.container.appendChild(this.a.container),this.value.copy(e)}return a.prototype.update=function(){this.r.update(),this.g.update(),this.b.update(),this.a.update(),this.value.set(this.r.value,this.g.value,this.b.value,this.a.value)},a}(),Draw=function(){function a(){var b=new VertData(3,!1,new Float32Array(3*a.BUFFER_SIZE)),c=new VertData(4,!1,new Float32Array(4*a.BUFFER_SIZE)),d=new IndexData(new Uint16Array(a.BUFFER_SIZE)),e=new Mesh;e.vert_data.position=b,e.vert_data.color=c,e.index_data.indices=d,e.draw_mode=gl.LINES,e.update_mode=gl.DYNAMIC_DRAW,e.bind(),this.mesh=e,this.positions=b,this.colors=c,this.indices=d,this.count=0,this.matrix=new Mat4,this.color=Color.white}return a.prototype.bind=function(){this.mesh.update(),this.material=new Material(onyx.resources.shaders.vertex)},a.prototype.line=function(a,b){var c=6*this.count,d=this.positions.data,e=this.colors.data,f=this.indices.data,g=this.color;this.matrix.mul_point(a),this.matrix.mul_point(b),d[c]=a.x,d[c+1]=a.y,d[c+2]=a.z,d[c+3]=b.x,d[c+4]=b.y,d[c+5]=b.z,c=8*this.count,e[c]=g.r,e[c+1]=g.g,e[c+2]=g.b,e[c+3]=g.a,e[c+4]=g.r,e[c+5]=g.g,e[c+6]=g.b,e[c+7]=g.a,c=2*this.count,f[c]=c,f[c+1]=c+1,this.count+=1},a.prototype.ray=function(a,b){this.line(a,Vec3.tmpA.copy(a).add(b))},a.prototype.rect=function(a,b){var c=a/2,d=b/2,e=Vec3.tmpA,f=Vec3.tmpB;this.line(e.set(-c,-d),f.set(-c,d)),this.line(e.set(-c,d),f.set(c,d)),this.line(e.set(c,d),f.set(c,-d)),this.line(e.set(c,-d),f.set(-c,-d))},a.prototype.cube=function(a,b,c){var d=a/2,e=b/2,f=c/2,g=Vec3.tmpA,h=Vec3.tmpB;this.line(g.set(-d,-e,-f),h.set(-d,e,-f)),this.line(g.set(-d,e,-f),h.set(d,e,-f)),this.line(g.set(d,e,-f),h.set(d,-e,-f)),this.line(g.set(d,-e,-f),h.set(-d,-e,-f)),this.line(g.set(-d,-e,f),h.set(-d,e,f)),this.line(g.set(-d,e,f),h.set(d,e,f)),this.line(g.set(d,e,f),h.set(d,-e,f)),this.line(g.set(d,-e,f),h.set(-d,-e,f)),this.line(g.set(-d,-e,-f),h.set(-d,-e,f)),this.line(g.set(-d,e,-f),h.set(-d,e,f)),this.line(g.set(d,e,-f),h.set(d,e,f)),this.line(g.set(d,-e,-f),h.set(d,-e,f))},a.prototype.circle=function(a,b){for(var c=Consts.TAU/b,d=Math.tan(c),e=Math.cos(c),f=a,g=0,h=Vec3.tmpC.set(f+a,g),i=0;b+1>i;++i){var j=Vec3.tmpD.set(f,g);this.line(h,j),h.copy(j);var k=-g,l=f;f+=k*d,g+=l*d,f*=e,g*=e}},a.prototype.sphere=function(a,b,c){var d,e,f=Vec3.tmpA.set(0,0,0),g=Vec3.tmpB;for(d=0;b>=d;++d){var h=d*Math.PI/b,i=Math.sin(h),j=Math.cos(h);for(e=0;c>=e;++e){var k=2*e*Math.PI/c,l=Math.sin(k),m=Math.cos(k),n=m*i,o=j,p=l*i;g.set(n*a,o*a,p*a),this.line(f,g),f.copy(g)}}},a.prototype.axes=function(a){var b=Vec3.tmpA,c=Vec3.tmpB.set(.5,0,0),d=Vec3.tmpC.set(0,.5,0),e=Vec3.tmpD.set(0,0,.5),f=this.color,g=this.line;a.get_pos(b),a.mul_point(c),a.mul_point(d),a.mul_point(e),f=Color.red,g(b,c),f=Color.green,g(b,d),f=Color.blue,g(b,e),f=Color.white},a.prototype.bounds=function(a){this.color.set(.23,.5,.56,1),a.center(Vec3.tmpA),this.matrix.set_pos(Vec3.tmpA),this.cube(a.width(),a.height(),a.depth()),this.color=Color.white,this.matrix.identity()},a.prototype.render=function(a,b,c){this.matrix.identity(),this.mesh.update(),this.indices.count=2*this.count,this.material.bind(),this.material.set_mat4("model",this.matrix),this.material.set_mat4("view",b),this.material.set_mat4("proj",c),a.draw_mesh(this.mesh,this.material.shader),this.material.unbind()},a.prototype.clear=function(){this.count=0,this.matrix.identity(),this.color=Color.white,this.mesh.dirty=!0},a.BUFFER_SIZE=2048,a}(),Bezier=function(){function a(a,b,c,d){return this.a=new Vec3,this.b=new Vec3,this.c=new Vec3,this.d=new Vec3,this.set(a||this.a,b||this.b,c||this.c,d||this.d),this}return a.prototype.set=function(a,b,c,d){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this.d.copy(d),this},a.prototype.copy=function(a){return this.set(a.a,a.b,a.c,a.d),this},a.prototype.eval=function(a){var b=1-a,c=a*a,d=b*b,e=d*b,f=c*a,g=e*this.a.y;return g+=3*d*a*this.b.y,g+=3*b*c*this.c.y,g+=f*this.d.y},a}(),Easing=function(){function a(){}return a.lerp=function(a,b,c){return(1-c)*a+c*b},a.quadratic=function(b,c,d){return a.lerp(b,c,2*d-d*d)},a}(),Entity=function(){function a(){this.parent=null,this.children=[],this.data={},this.active=!0,this.visible=!0,this.draw_layer=0,this.dirty=!0,this.pos=new Vec3,this.scale=new Vec3(1,1,1),this.rot=new Quat,this.matrix=new Mat4,this.bounds=new AABB}return a.prototype.set_active=function(a){this.active=a;for(var b in this.children)this.children[b].set_active(a)},a.prototype.set_parent=function(a){this.parent!==a&&(null!==this.parent&&null===a?(this.parent.remove_child(this),this.parent=null):null!==this.parent&&null!==a?(this.parent.remove_child(this),this.parent=a,this.parent.add_child(this)):(this.parent=a,this.parent.add_child(this)))},a.prototype.add_child=function(a){this.children.push(a)},a.prototype.remove_child=function(a){var b=this.children.indexOf(a,0);void 0!=b&&this.children.splice(b,1)},a.prototype.move=function(a){this.pos.add(a),this.set_dirty()},a.prototype.movef=function(a,b,c){this.move(Vec3.tmp(a,b,c))},a.prototype.set_pos=function(a){this.pos.copy(a),this.set_dirty()},a.prototype.set_posf=function(a,b,c){this.pos.set(a,b,c),this.set_dirty()},a.prototype.get_pos=function(a){this.matrix.get_pos(a)},a.prototype.rotate=function(a){this.rot.mul(a),this.set_dirty()},a.prototype.rotatef=function(a,b,c){this.rotate(Quat.tmpA.euler(a,b,c))},a.prototype.set_rot=function(a){this.rot.copy(a),this.set_dirty()},a.prototype.set_rotf=function(a,b,c){this.set_rot(Quat.tmpA.euler(a,b,c))},a.prototype.get_rot=function(a){this.matrix.get_rot(a)},a.prototype.set_scale=function(a){this.scale.copy(a),this.set_dirty()},a.prototype.set_scalef=function(a,b,c){this.set_scale(Vec3.tmp(a,b,c))},a.prototype.get_scale=function(a){this.matrix.get_scale(a)},a.prototype.set_dirty=function(){this.dirty=!0;for(var a in this.children)this.children[a].set_dirty()},a.prototype.update_transform=function(){if(0!=this.dirty){var a=this.matrix;a.compose(this.pos,this.scale,this.rot),this.parent&&a.mul(this.parent.matrix);for(var b=this.children.length,c=0;b>c;++c)this.children[c].update_transform();this.dirty=!1}},a.prototype.render=function(a,b){if(this.mesh&&this.material){this.mesh.update(),this.material.bind(),this.material.set_mat4("model",this.matrix),this.material.set_mat4("vp",b.view_projection);var c=Mat4.tmpA.copy(this.matrix).mul(b.view_projection);this.material.set_mat4("mvp",c);var d=Mat4.tmpB.copy(this.matrix).mul(b.view);this.material.set_mat4("mv",d);var e=Mat3.tmpA.copy_mat4(d);e.invert(),this.material.set_mat3("nmatrix",e),a.draw_mesh(this.mesh,this.material.shader),this.material.unbind()}},a}(),KeyState;!function(a){a[a.DOWN=0]="DOWN",a[a.HELD=1]="HELD",a[a.UP=2]="UP",a[a.RELEASED=3]="RELEASED"}(KeyState||(KeyState={}));var KeyCode;!function(a){a[a.MOUSE_LEFT=0]="MOUSE_LEFT",a[a.MOUSE_RIGHT=1]="MOUSE_RIGHT",a[a.ESC=27]="ESC",a[a.LEFT=37]="LEFT",a[a.UP=38]="UP",a[a.RIGHT=39]="RIGHT",a[a.DOWN=40]="DOWN",a[a.X=88]="X",a[a.Z=90]="Z",a[a.W=87]="W",a[a.A=65]="A",a[a.S=83]="S",a[a.D=68]="D"}(KeyCode||(KeyCode={}));var Input=function(){function a(a){var b=this;this.mouse_pos=new Vec3,this.mouse_delta=new Vec3,this.mouse_scroll=0,this.wheel=0,this.last_wheel=0,this.keys=[],a.onkeydown=function(a){b.key_down(b,a)},a.onkeyup=function(a){b.key_up(b,a)},a.onmousedown=function(a){b.mouse_down(b,a)},a.onmouseup=function(a){b.mouse_up(b,a)},a.onmousemove=function(a){b.mouse_move(b,a)},a.addEventListener("wheel",function(a){return b.mouse_wheel(b,a)},!1);for(var c in KeyCode)isNaN(c)||this.add_key(c)}return a.prototype.add_key=function(a){this.keys[a]=3},a.prototype.update=function(){for(var a in this.keys)0==this.keys[a]?this.keys[a]=1:2==this.keys[a]&&(this.keys[a]=3);this.mouse_scroll=this.wheel==this.last_wheel?0:this.wheel,this.last_wheel=this.wheel,this.mouse_delta.set(0,0)},a.prototype.up=function(a){return this.get_key(a,2)},a.prototype.down=function(a){return this.get_key(a,0)},a.prototype.held=function(a){return this.get_key(a,1)},a.prototype.released=function(a){return this.get_key(a,3)},a.prototype.get_key=function(a,b){return void 0===this.keys[a]?!1:this.keys[a]==b},a.prototype.key_down=function(a,b){void 0!=a.keys[b.keyCode]&&(1!=a.keys[b.keyCode]&&(a.keys[b.keyCode]=0),b.preventDefault())},a.prototype.key_up=function(a,b){void 0!=a.keys[b.keyCode]&&(3!=a.keys[b.keyCode]&&(a.keys[b.keyCode]=2),b.preventDefault())},a.prototype.mouse_move=function(a,b){var c=b.clientX,d=b.clientY;a.mouse_delta.set(c,d).sub(a.mouse_pos),a.mouse_pos.set(c,d)},a.prototype.mouse_wheel=function(a,b){a.wheel=b.deltaY},a.prototype.mouse_up=function(a,b){3!=a.keys[b.button]&&(a.keys[b.button]=2)},a.prototype.mouse_down=function(a,b){1!=a.keys[b.button]&&(a.keys[b.button]=0)},a}(),HitInfo=function(){function a(){this.point=new Vec3,this.normal=new Vec3,this.t=0}return a.prototype.clear=function(){this.point.set(0,0,0),this.normal.set(0,0,0),this.t=0},a.tmpA=new a,a}(),Intersect=function(){function a(){}return a.aabb_ray=function(a,b,c){c=c||HitInfo.tmpA,c.clear();var d=1/b.dir.x,e=1/b.dir.y,f=1/b.dir.z,g=(a.min.x-b.origin.x)*d,h=(a.max.x-b.origin.x)*d,i=(a.min.y-b.origin.y)*e,j=(a.max.y-b.origin.y)*e,k=(a.min.z-b.origin.z)*f,l=(a.max.z-b.origin.z)*f,m=Math.max(Math.max(Math.min(g,h),Math.min(i,j)),Math.min(k,l)),n=Math.min(Math.min(Math.max(g,h),Math.max(i,j)),Math.max(k,l));if(0>n||m>n)return!1;var o=Vec3.tmpA.copy(b.dir).mulf(m);return c.point.copy(b.origin).add(o),c.t=m,!0},a.point_triangle=function(a,b,c,d){var e=(-c.y*d.x+b.y*(-c.x+d.x)+b.x*(c.y-d.y)+c.x*d.y)/2,f=0>e?-1:1,g=(b.y*d.x-b.x*d.y+(d.y-b.y)*a.x+(b.x-d.x)*a.y)*f,h=(b.x*c.y-b.y*c.x+(b.y-c.y)*a.x+(c.x-b.x)*a.y)*f;return g>0&&h>0&&2*e*f>g+h},a.triangle_ray=function(b,c,d,e,f){f=f||HitInfo.tmpA,f.clear();var g=Vec3.tmpA.copy(c).sub(b),h=Vec3.tmpB.copy(d).sub(b);Vec3.cross(g,h,Vec3.tmpC);var i=Vec3.tmpC.normalize(),j=-(Vec3.dot(i,e.origin)+Vec3.dot(i,b))/Vec3.dot(i,e.dir),k=Vec3.tmpA.copy(e.origin),l=Vec3.tmpB.copy(e.dir).mulf(j);return k.add(l),a.point_triangle(k,b,c,d)?(f.point.copy(k),f.t=j,f.normal.copy(i),!0):!1},a}(),Mat3=function(){function a(){this.m=new Float32Array(9),this.identity()}return a.prototype.identity=function(){var a=this.m;return a[1]=a[2]=a[3]=a[5]=a[6]=a[7]=0,a[0]=a[4]=a[8]=1,this},a.prototype.copy=function(a){for(var b=0;9>b;++b)this.m[b]=a.m[b];return this},a.prototype.copy_mat4=function(a){var b=this.m;return b[0]=a.m[0],b[1]=a.m[1],b[2]=a.m[2],b[3]=a.m[4],b[4]=a.m[5],b[5]=a.m[6],b[6]=a.m[8],b[7]=a.m[9],b[8]=a.m[10],this},a.prototype.determinant=function(){var a=this.m;return a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6])},a.prototype.invert=function(){var b=a.tmp.copy(this).m,c=this.m;b[0]=c[4]*c[8]-c[5]*c[7],b[1]=c[2]*c[7]-c[1]*c[8],b[2]=c[1]*c[5]-c[2]*c[4],b[3]=c[5]*c[6]-c[3]*c[8],b[4]=c[0]*c[8]-c[2]*c[6],b[5]=c[2]*c[3]-c[0]*c[5],b[6]=c[3]*c[7]-c[4]*c[6],b[7]=c[1]*c[6]-c[0]*c[7],b[8]=c[0]*c[4]-c[1]*c[3];var d=c[0]*b[0]+c[1]*b[3]+c[2]*b[6];if(Math.abs(d)<=Consts.EPSILON)return this.identity();var e=1/d;return c[0]=e*b[0],c[1]=e*b[1],c[2]=e*b[2],c[3]=e*b[3],c[4]=e*b[4],c[5]=e*b[5],c[6]=e*b[6],c[7]=e*b[7],c[8]=e*b[8],this},a.prototype.transpose=function(){var b=a.tmp.copy(this).m,c=this.m;return c[1]=b[3],c[2]=b[6],c[3]=b[1],c[5]=b[7],c[6]=b[2],c[7]=b[5],this},a.tmp=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a}(),Mat4=function(){function a(){this.m=new Float32Array(16),this.identity()}return a.prototype.identity=function(){var a=this.m;return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,this},a.prototype.copy=function(a){for(var b=0;16>b;++b)this.m[b]=a.m[b];return this},a.prototype.compose=function(a,b,c){return this.set_rot(c),this.scale(b),this.set_pos(a),this},a.prototype.get_pos=function(a){var b=this.m;a.x=b[12],a.y=b[13],a.z=b[14]},a.prototype.set_pos=function(a){var b=this.m;return b[12]=a.x,b[13]=a.y,b[14]=a.z,this},a.prototype.get_scale=function(a){var b=this.m;a.x=b[0],a.y=b[5],a.z=b[10]},a.prototype.set_scale=function(a){var b=this.m;return b[0]=a.x,b[5]=a.y,b[10]=a.z,this},a.prototype.scale=function(a){var b=this.m;return b[0]*=a.x,b[1]*=a.x,b[2]*=a.x,b[3]*=a.x,b[4]*=a.y,b[5]*=a.y,b[6]*=a.y,b[7]*=a.y,b[8]*=a.z,b[9]*=a.z,b[10]*=a.z,b[11]*=a.z,this},a.prototype.get_rot=function(a){var b=this.m,c=0,d=1+b[0]+b[5]+b[10];return d>Consts.EPSILON?(c=2*Math.sqrt(d),a.x=(b[9]-b[6])/c,a.y=(b[2]-b[8])/c,a.z=(b[4]-b[1])/c,void(a.w=.25*c)):b[0]>b[5]&&b[0]>b[10]?(c=2*Math.sqrt(1+b[0]-b[5]-b[10]),a.x=.25*c,a.y=(b[4]+b[1])/c,a.z=(b[2]+b[8])/c,void(a.w=(b[9]-b[6])/c)):b[5]>b[10]?(c=2*Math.sqrt(1+b[5]-b[0]-b[10]),a.x=(b[4]+b[1])/c,a.y=.25*c,a.z=(b[9]+b[6])/c,void(a.w=(b[2]-b[8])/c)):(c=2*Math.sqrt(1+b[10]-b[0]-b[5]),a.x=(b[2]+b[8])/c,a.y=(b[9]+b[6])/c,a.z=.25*c,void(a.w=(b[4]-b[1])/c))},a.prototype.set_rot=function(a){var b=this.m,c=2*a.x,d=2*a.y,e=2*a.z,f=a.x*c,g=a.x*d,h=a.x*e,i=a.y*d,j=a.y*e,k=a.z*e,l=a.w*c,m=a.w*d,n=a.w*e;return b[0]=1-(i+k),b[1]=g+n,b[2]=h-m,b[3]=0,b[4]=g-n,b[5]=1-(f+k),b[6]=j+l,b[7]=0,b[8]=h+m,b[9]=j-l,b[10]=1-(f+i),b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this},a.prototype.mul_point=function(a){var b=this.m,c=b[0]*a.x+b[4]*a.y+b[8]*a.z+b[12],d=b[1]*a.x+b[5]*a.y+b[9]*a.z+b[13],e=b[2]*a.x+b[6]*a.y+b[10]*a.z+b[14];a.set(c,d,e)},a.prototype.mul_projection=function(a){var b=this.m,c=1/(b[3]*a.x+b[7]*a.y+b[11]*a.z+b[15]),d=(b[0]*a.x+b[4]*a.y+b[8]*a.z+b[12])*c,e=(b[1]*a.x+b[5]*a.y+b[9]*a.z+b[13])*c,f=(b[2]*a.x+b[6]*a.y+b[10]*a.z+b[14])*c;a.set(d,e,f)},a.prototype.mul=function(b){var c=a.tmp.copy(this).m,d=b.m,e=this.m;return e[0]=c[0]*d[0]+c[1]*d[4]+c[2]*d[8]+c[3]*d[12],e[1]=c[0]*d[1]+c[1]*d[5]+c[2]*d[9]+c[3]*d[13],e[2]=c[0]*d[2]+c[1]*d[6]+c[2]*d[10]+c[3]*d[14],e[3]=c[0]*d[3]+c[1]*d[7]+c[2]*d[11]+c[3]*d[15],e[4]=c[4]*d[0]+c[5]*d[4]+c[6]*d[8]+c[7]*d[12],e[5]=c[4]*d[1]+c[5]*d[5]+c[6]*d[9]+c[7]*d[13],e[6]=c[4]*d[2]+c[5]*d[6]+c[6]*d[10]+c[7]*d[14],e[7]=c[4]*d[3]+c[5]*d[7]+c[6]*d[11]+c[7]*d[15],e[8]=c[8]*d[0]+c[9]*d[4]+c[10]*d[8]+c[11]*d[12],e[9]=c[8]*d[1]+c[9]*d[5]+c[10]*d[9]+c[11]*d[13],e[10]=c[8]*d[2]+c[9]*d[6]+c[10]*d[10]+c[11]*d[14],e[11]=c[8]*d[3]+c[9]*d[7]+c[10]*d[11]+c[11]*d[15],e[12]=c[12]*d[0]+c[13]*d[4]+c[14]*d[8]+c[15]*d[12],e[13]=c[12]*d[1]+c[13]*d[5]+c[14]*d[9]+c[15]*d[13],e[14]=c[12]*d[2]+c[13]*d[6]+c[14]*d[10]+c[15]*d[14],e[15]=c[12]*d[3]+c[13]*d[7]+c[14]*d[11]+c[15]*d[15],this},a.prototype.determinant=function(){var a=this.m,b=a[0]*a[5]-a[1]*a[4],c=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],f=a[1]*a[7]-a[3]*a[5],g=a[2]*a[7]-a[3]*a[6],h=a[8]*a[13]-a[9]*a[12],i=a[8]*a[14]-a[10]*a[12],j=a[8]*a[15]-a[11]*a[12],k=a[9]*a[14]-a[10]*a[13],l=a[9]*a[15]-a[11]*a[13],m=a[10]*a[15]-a[11]*a[14];return b*m-c*l+d*k+e*j-f*i+g*h},a.prototype.transpose=function(){var b=a.tmp.copy(this),c=this.m;return c[1]=b[4],c[2]=b[8],c[3]=b[12],c[4]=b[1],c[6]=b[9],c[7]=b[13],c[8]=b[2],c[9]=b[6],c[11]=b[14],c[12]=b[3],c[13]=b[7],c[14]=b[11],c[15]=b[15],this},a.prototype.invert=function(){var b=a.tmp.copy(this).m,c=this.m,d=b[2]*b[7]-b[6]*b[3],e=b[2]*b[11]-b[10]*b[3],f=b[2]*b[15]-b[14]*b[3],g=b[6]*b[11]-b[10]*b[7],h=b[6]*b[15]-b[14]*b[7],i=b[10]*b[15]-b[14]*b[11],j=i*b[5]-h*b[9]+g*b[13],k=-(i*b[1]-f*b[9]+e*b[13]),l=h*b[1]-f*b[5]+d*b[13],m=-(g*b[1]-e*b[5]+d*b[9]),n=1/(j*b[0]+k*b[4]+l*b[8]+m*b[12]);return c[0]=j*n,c[1]=k*n,c[2]=l*n,c[3]=m*n,c[4]=-(i*b[4]-h*b[8]+g*b[12])*n,c[5]=(i*b[0]-f*b[8]+e*b[12])*n,c[6]=-(h*b[0]-f*b[4]+d*b[12])*n,c[7]=(g*b[0]-e*b[4]+d*b[8])*n,d=b[1]*b[7]-b[5]*b[3],e=b[1]*b[11]-b[9]*b[3],f=b[1]*b[15]-b[13]*b[3],g=b[5]*b[11]-b[9]*b[7],h=b[5]*b[15]-b[13]*b[7],i=b[9]*b[15]-b[13]*b[11],c[8]=(i*b[4]-h*b[8]+g*b[12])*n,c[9]=-(i*b[0]-f*b[8]+e*b[12])*n,c[10]=(h*b[0]-f*b[4]+d*b[12])*n,c[11]=-(g*b[0]-e*b[4]+d*b[8])*n,d=b[6]*b[1]-b[2]*b[5],e=b[10]*b[1]-b[2]*b[9],f=b[14]*b[1]-b[2]*b[13],g=b[10]*b[5]-b[6]*b[9],h=b[14]*b[5]-b[6]*b[13],i=b[14]*b[9]-b[10]*b[13],c[12]=-(i*b[4]-h*b[8]+g*b[12])*n,c[13]=(i*b[0]-f*b[8]+e*b[12])*n,c[14]=-(h*b[0]-f*b[4]+d*b[12])*n,c[15]=(g*b[0]-e*b[4]+d*b[8])*n,this},a.prototype.invert_affine=function(){var b=a.tmp.copy(this).m,c=this.m,d=b[10]*b[5]-b[6]*b[9],e=b[2]*b[9]-b[10]*b[1],f=b[6]*b[1]-b[2]*b[5],g=1/(b[0]*d+b[4]*e+b[8]*f);return d*=g,e*=g,f*=g,b[0]*=g,b[4]*=g,b[8]*=g,c[0]=d,c[1]=e,c[2]=f,c[3]=0,c[4]=b[8]*b[6]-b[4]*b[10],c[5]=b[0]*b[10]-b[8]*b[2],c[6]=b[4]*b[2]-b[0]*b[6],c[7]=0,c[8]=b[4]*b[9]-b[8]*b[5],c[9]=b[8]*b[1]-b[0]*b[9],c[10]=b[0]*b[5]-b[4]*b[1],c[11]=0,c[12]=-(c[0]*b[12]+c[4]*b[13]+c[8]*b[14]),c[13]=-(c[1]*b[12]+c[5]*b[13]+c[9]*b[14]),c[14]=-(c[2]*b[12]+c[6]*b[13]+c[10]*b[14]),c[15]=1,this},a.tmp=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a}(),TextureSlot=function(){function a(){this.name=null,this.texture=null,this.offset=null}return a}(),Material=function(){function a(b){this.textures=[],this.shader=b;for(var c=0;c<a.MAX_TEXTURES;++c)this.textures.push(new TextureSlot);return this}return a.find=function(a){return onyx.resources.materials[a]},a.prototype.bind=function(){this.shader.bind();for(var b=0;b<a.MAX_TEXTURES;++b){var c=this.textures[b];null!==c.texture&&(gl.activeTexture(gl.TEXTURE0+c.offset),c.texture.bind())}},a.prototype.unbind=function(){for(var b=0;b<a.MAX_TEXTURES;++b){var c=this.textures[b];null!==c.texture&&c.texture.unbind()}this.shader.unbind()},a.prototype.set_texture=function(b,c,d){0>d||d>=a.MAX_TEXTURES;var e=this.textures[d];e.name=b,e.texture=c,e.offset=d,this.set_int(b,d)},a.prototype.set_int=function(a,b){gl.uniform1i(this.shader.uniform(a),b)},a.prototype.set_float=function(a,b){gl.uniform1f(this.shader.uniform(a),b)},a.prototype.set_vec2=function(a,b){gl.uniform2f(this.shader.uniform(a),b.x,b.y)},a.prototype.set_vec3=function(a,b){gl.uniform3f(this.shader.uniform(a),b.x,b.y,b.z)},a.prototype.set_vec4=function(a,b){gl.uniform4f(this.shader.uniform(a),b.x,b.y,b.z,b.w)},a.prototype.set_color=function(a,b){gl.uniform4f(this.shader.uniform(a),b.r,b.g,b.b,b.a)},a.prototype.set_mat3=function(a,b){gl.uniformMatrix3fv(this.shader.uniform(a),gl.FALSE,b.m)},a.prototype.set_mat4=function(a,b){gl.uniformMatrix4fv(this.shader.uniform(a),gl.FALSE,b.m)},a.MAX_TEXTURES=8,a}(),VertData=function(){function a(a,b,c){this.handle=null,this.stride=a,this.normalized=b,this.data=c,this.count=c.length}return a}(),IndexData=function(){function a(a){this.handle=null,this.data=a,this.count=a.length}return a}(),Mesh=function(){function a(){this.draw_mode=gl.TRIANGLES,this.update_mode=gl.STATIC_DRAW,this.dirty=!0,this.vert_data=[],this.index_data=[],this.bounds=new AABB}return a.prototype.duplicate=function(){var b=new a;b.draw_mode=this.draw_mode,b.update_mode=this.update_mode;var c=this.vert_data,d=this.index_data;for(var e in c){var f=c[e];b.vert_data[e]=new VertData(f.stride,f.normalized,new Float32Array(f.data))}for(var g in d){var h=d[g];b.index_data[g]=new IndexData(new Uint16Array(h.data))}return b.bind(),b},a.prototype.bind=function(){var a=this.vert_data,b=this.index_data;for(var c in a){var d=a[c];null===d.handle&&(d.handle=gl.createBuffer(),void 0===d.handle)}for(var e in b){var f=b[e];null===f.handle&&(f.handle=gl.createBuffer())}return this.dirty=!0,this.update(),this},a.prototype.release=function(){var a=this.vert_data,b=this.index_data;for(var c in a)gl.deleteBuffer(a[c].handle);for(var d in this.index_data)gl.deleteBuffer(b[d].handle);a=[],b=[]},a.prototype.update=function(){if(0!=this.dirty){var a=this.vert_data,b=this.index_data;for(var c in a){var d=a[c];gl.bindBuffer(gl.ARRAY_BUFFER,d.handle),gl.bufferData(gl.ARRAY_BUFFER,d.data,this.update_mode)}for(var e in b){var f=b[e];gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,f.handle),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,f.data,this.update_mode)}gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),this.update_bounds(),this.dirty=!1}},a.prototype.update_bounds=function(){var a=this.vert_data.position,b=this.bounds;b.min.set(a.data[0],a.data[1],a.data[2]),b.max.set(a.data[0],a.data[1],a.data[2]);for(var c=3;c<a.count;c+=3){var d=Vec3.tmpA.set(a.data[c],a.data[c+1],a.data[c+2]);d.x<b.min.x&&(b.min.x=d.x),d.y<b.min.y&&(b.min.y=d.y),d.z<b.min.z&&(b.min.z=d.z),d.x>b.max.x&&(b.max.x=d.x),d.y>b.max.y&&(b.max.y=d.y),d.z>b.max.z&&(b.max.z=d.z)}},a.prototype.flip_normals=function(){for(var a=this.vert_data.normal,b=0;b<a.count;++b)a.data[b]=-a.data[b];this.dirty=!0
},a.prototype.set_vertex_alpha=function(a){for(var b=this.vert_data.color,c=0;c<b.count;c+=4)b.data[c+3]=a;this.dirty=!0},a.prototype.set_vertex_colors=function(a,b,c,d){for(var e=this.vert_data.color,f=0;f<e.count;f+=4)e.data[f]=a,e.data[f+1]=b,e.data[f+2]=c,e.data[f+3]=d;this.dirty=!0},a.find=function(a){return onyx.resources.meshes[a]},a}(),MeshTools=function(){function a(){}return a.quad=function(a,b,c){var d=a/2,e=b/2,c=c||0,f=new Float32Array([-d,-e,c,d,-e,c,-d,e,c,d,e,c]),g=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]),h=new Float32Array([0,0,1,0,0,1,1,1]),i=new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,-1]),j=new Uint16Array([0,1,3,0,3,2]),k=new Mesh;return k.vert_data.position=new VertData(3,!1,f),k.vert_data.color=new VertData(4,!1,g),k.vert_data.normal=new VertData(3,!0,i),k.vert_data.uv=new VertData(2,!1,h),k.index_data.triangles=new IndexData(j),k.bind(),k},a.cube=function(a,b,c){for(var d=a/2,e=b/2,f=c/2,g=new Float32Array([-d,-e,f,d,-e,f,-d,e,f,d,e,f,d,-e,f,d,-e,-f,d,e,f,d,e,-f,-d,-e,-f,d,-e,-f,-d,-e,f,d,-e,f,-d,-e,-f,-d,-e,f,-d,e,-f,-d,e,f,-d,e,f,d,e,f,-d,e,-f,d,e,-f,d,-e,-f,-d,-e,-f,d,e,-f,-d,e,-f]),h=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),i=new Float32Array(96),j=0;96>j;++j)i[j]=1;var k=new Float32Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1]),l=new Uint16Array([0,1,3,0,3,2,4,5,7,4,7,6,8,9,11,8,11,10,12,13,15,12,15,14,16,17,19,16,19,18,20,21,23,20,23,22]),m=new Mesh;return m.vert_data.position=new VertData(3,!1,g),m.vert_data.normal=new VertData(3,!0,h),m.vert_data.color=new VertData(4,!1,i),m.vert_data.uv=new VertData(2,!1,k),m.index_data.triangles=new IndexData(l),m.bind(),m},a.eye_piece=function(){},a}(),onyx,Onyx=function(){function a(a){this.container=a,this.container.classList.add("onyx"),this.view=new Rect(0,0,a.offsetWidth,a.offsetHeight);var b=document.createElement("canvas");return b.classList.add("glcanvas"),b.width=this.view.width,b.height=this.view.height,a.appendChild(b),this.renderer=new Renderer(b),0==this.renderer.success?void this.fail():(this.resources=new Resources,this.scene=new Scene,this.draw=new Draw,void(this.success=!0))}return a.prototype.fail=function(){this.success=!1;var a=document.createElement("div");a.classList.add("nogl"),a.innerHTML="Sorry, your browser doesn't seem to support WebGL (required for 3D content).",this.container.appendChild(a)},a.prototype.set_scene=function(a){this.scene=a,a.draw=this.draw},a.prototype.start=function(){var a=0;a=void 0==window.performance?Date.now():window.performance.now(),this.input=new Input(document),this.time_start=a,this.time_last_update=a,this.time_elapsed=0,this.dt=0,this.draw.bind(),this.scene.draw=this.draw},a.prototype.update=function(a){this.time_elapsed=a-this.time_start,this.dt=(a-this.time_last_update)/1e3,this.time_last_update=a,this.frames++},a.prototype.render=function(){this.scene.render(this.renderer)},a}(),Quat=function(){function a(){this.identity()}return a.prototype.set=function(a,b,c,d){return this.x=a,this.y=b,this.z=c,this.w=d,this},a.prototype.copy=function(a){return this.set(a.x,a.y,a.z,a.w),this},a.prototype.identity=function(){return this.set(0,0,0,1),this},a.prototype.euler=function(a,b,c){var d=a*Consts.DEG2RAD/2,e=b*Consts.DEG2RAD/2,f=c*Consts.DEG2RAD/2,g=Math.sin(d),h=Math.sin(e),i=Math.sin(f),j=Math.cos(d),k=Math.cos(e),l=Math.cos(f);return this.x=g*k*l-j*h*i,this.y=j*h*l+g*k*i,this.z=j*k*i-g*h*l,this.w=j*k*l+g*h*i,this.normalize(),this},a.prototype.put_euler=function(a){var b=.499,c=this.x*this.y+this.z*this.w;if(c>b)a.x=2*Math.atan2(this.x,this.w),a.y=Math.PI/2,a.z=0;else if(-b>c)a.x=-2*Math.atan2(this.x,this.w),a.y=-Math.PI/2,a.z=0;else{var d=this.x*this.x,e=this.y*this.y,f=this.z*this.z;a.x=Math.atan2(2*this.y*this.w-2*this.x*this.z,1-2*e-2*f),a.y=Math.asin(2*c),a.z=Math.atan2(2*this.x*this.w-2*this.y*this.z,1-2*d-2*f)}},a.prototype.angle_axis=function(a,b){var c=.5*a*Consts.DEG2RAD,d=Math.sin(c);return this.w=Math.cos(c),this.x=d*b.x,this.y=d*b.y,this.z=d*b.z,this},a.prototype.put_angle_axis=function(a,b){var c=this.sqr_mag();if(c>0){var d=1/Math.sqrt(c);a=2*Math.acos(this.w)*Consts.RAD2DEG,b.x=this.x*d,b.y=this.y*d,b.z=this.z*d}else a=0,b.x=1,b.y=0,b.z=0},a.prototype.from_to=function(a,b){var c=Vec3.tmpA;c.copy(a).normalize();var d=Vec3.tmpB;d.copy(b).normalize(),this.w=1+Vec3.dot(c,d),Vec3.cross(c,d,Vec3.tmpC);var e=Vec3.tmpC;return this.x=e.x,this.y=e.y,this.z=e.z,this.normalize(),this},a.prototype.sqr_mag=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a.prototype.mag=function(){return Math.sqrt(this.sqr_mag())},a.prototype.normalize=function(){var a=this.mag();if(a>Consts.EPSILON){var b=1/a;this.x*=b,this.y*=b,this.z*=b,this.w*=b}return this},a.prototype.conjugate=function(){return this.set(-this.x,-this.y,-this.z,this.w),this},a.prototype.invert=function(){return this.conjugate().normalize(),this},a.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w},a.prototype.mul=function(b){var c=a.tmp.copy(this);return this.w=c.w*b.w-c.x*b.x-c.y*b.y-c.z*b.z,this.x=c.w*b.x+c.x*b.w+c.y*b.z-c.z*b.y,this.y=c.w*b.y+c.y*b.w+c.z*b.x-c.x*b.z,this.z=c.w*b.z+c.z*b.w+c.x*b.y-c.y*b.x,this},a.prototype.mul_vec=function(a){var b=this.x,c=this.y,d=this.z,e=this.w,f=2*(c*a.z-d*a.y),g=2*(d*a.x-b*a.z),h=2*(b*a.y-c*a.x),i=c*h-d*g,j=d*f-b*h,k=b*g-c*f;a.x=a.x+e*f+i,a.y=a.y+e*g+j,a.z=a.z+e*h+k},a.lerp=function(a,b,c,d,e){e=e||Easing.lerp,a.x=e(b.x,c.x,d),a.y=e(b.y,c.y,d),a.z=e(b.z,c.z,d),a.w=e(b.w,c.w,d)},a.tmp=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a}(),Ray=function(){function a(a,b){return this.origin=new Vec3,this.dir=new Vec3,this.set(a||this.origin,b||this.dir),this}return a.prototype.set=function(a,b){return this.origin.copy(a),this.dir.copy(b),this},a.prototype.copy=function(a){return this.set(a.origin,a.dir),this},a}(),Rect=function(){function a(a,b,c,d){return this.x=0,this.y=0,this.width=0,this.height=0,this.set(a||0,b||0,c||0,d||0),this}return a.prototype.set=function(a,b,c,d){return this.x=a,this.y=b,this.width=c,this.height=d,this},a.prototype.copy=function(a){return this.set(a.x,a.y,a.width,a.height),this},a._TMP=new a,a.tmpA=new a,a.tmpB=new a,a.tmpC=new a,a.tmpD=new a,a}(),RenderTarget=function(){function a(a,b,c,d){this.view=new Rect(a,b,c,d),this.frame_buffer=gl.createFramebuffer(),this.render_buffer=gl.createRenderbuffer(),this.texture=new Texture,this.bind(),this.texture.set_wrap_mode(gl.CLAMP_TO_EDGE,gl.CLAMP_TO_EDGE),this.texture.set_filter(gl.NEAREST,gl.NEAREST),this.texture.set_pixels(c,d,gl.RGBA,null),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.handle,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.render_buffer);var e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);e!=gl.FRAMEBUFFER_COMPLETE,this.unbind()}return a.prototype.release=function(){gl.deleteFrameBuffer(this.frame_buffer),gl.deleteRenderBuffer(this.render_buffer),this.texture.release()},a.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.frame_buffer),gl.bindRenderbuffer(gl.RENDERBUFFER,this.render_buffer),this.texture.bind()},a.prototype.unbind=function(){this.texture.unbind(),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)},a}(),gl=null,Renderer=function(){function a(a){this.success=!1,this.init(a)}return a.prototype.init=function(a){try{gl=a.getContext("experimental-webgl",{antialias:!1,premultipliedAlpha:!0})}catch(b){return}this.set_viewport(0,0,a.width,a.height),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.clearDepth(1),this.cull_face(!0),gl.cullFace(gl.BACK),gl.frontFace(gl.CCW),gl.enable(gl.SCISSOR_TEST),gl.scissor(0,0,a.width,a.height),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),this.success=!0},a.prototype.clear_color=function(a){gl.clearColor(a.r,a.g,a.b,a.a)},a.prototype.depth_test=function(a){a?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST)},a.prototype.cull_face=function(a){a?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE)},a.prototype.set_viewport=function(a,b,c,d){gl.viewport(a,b,c,d)},a.prototype.clear=function(a){switch(a){case 0:gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);break;case 1:gl.clear(gl.DEPTH_BUFFER_BIT)}},a.prototype.draw_mesh=function(a,b){for(var c in b.attributes){var d=b.attributes[c],e=a.vert_data[d.value.name];gl.enableVertexAttribArray(d.location),gl.bindBuffer(gl.ARRAY_BUFFER,e.handle),gl.vertexAttribPointer(d.location,e.stride,gl.FLOAT,e.normalized,0,0)}for(var f in a.index_data){var g=a.index_data[f];gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,g.handle),gl.drawElements(a.draw_mode,g.count,gl.UNSIGNED_SHORT,0)}gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)},a.prototype.flush=function(){gl.flush()},a}(),Resources=function(){function a(){this.load_complete=function(){},this.load_progress=function(){},this.shaders=[],this.materials=[],this.meshes=[],this.textures=[]}return a.prototype.preload=function(a,b,c){function d(a){var b=JSON.parse(a),c=b.meshes,d=b.shaders,e=b.textures;for(var g in c)f.resource_count+=1,f.load_mesh(g,c[g]);for(var h in d)f.resource_count+=1,f.load_shader(h,d[h]);for(var i in e)f.resource_count+=1,f.load_image(i,e[i])}function e(a){}var f=this;this.load_count=0,this.resource_count=0,this.load_complete=b,this.load_progress=c;var g=new Ajax;g.get(a,null,"application/json",d,e)},a.prototype.update_load_count=function(){this.load_count+=1;var a=this.load_count/this.resource_count*100;return this.load_count==this.resource_count?void this.load_complete():void this.load_progress(a)},a.prototype.load_image=function(a,b){var c=this,d=new Image;d.onload=function(){var b=new Texture;b.bind(),b.set_image(d),b.set_wrap_mode(gl.CLAMP_TO_EDGE,gl.CLAMP_TO_EDGE),b.set_filter(gl.LINEAR,gl.LINEAR),b.unbind(),c.textures[a]=b,c.update_load_count()},d.src=b.url},a.prototype.load_shader=function(a,b){function c(b){var c=JSON.parse(b),d=new Shader(c.vertex,c.fragment);e.shaders[a]=d,e.update_load_count()}function d(a){}var e=this,f=new Ajax;f.get(b.url,null,"application/json",c,d)},a.prototype.load_mesh=function(a,b){function c(b){var c=JSON.parse(b),d=new Mesh,f=c.vectors;for(var g in f){var h=f[g];d.vert_data[g]=new VertData(h.stride,h.norm,new Float32Array(h.data))}var i=c.indices;for(var j in i){var k=i[j];d.index_data[j]=new IndexData(new Uint16Array(k.data))}e.meshes[a]=d,e.update_load_count(),d.bind()}function d(a){}var e=this,f=new Ajax;f.get(b.url,null,"application/json",c,d)},a}(),Scene=function(){function a(){this.entities=[],this.cameras=[],this.num_cameras=0,this.num_entities=0}return a.prototype.add_entity=function(a){this.entities.push(a),this.num_entities++},a.prototype.add_camera=function(a){this.cameras.push(a),this.num_cameras++},a.prototype.update=function(){var a,b,c,d=this.cameras,e=this.entities,f=this.num_entities,g=this.num_cameras;for(a=0;g>a;++a)b=d[a],0!=b.entity.active&&b.update_transform();for(a=0;f>a;++a)c=e[a],0!=c.active&&c.update_transform()},a.prototype.render_camera=function(a,b){var c,d,e=this.entities,f=this.num_entities;for(a.clear_color(b.color),a.clear(b.clear_mode),c=0;f>c;++c)d=e[c],0!=d.active&&0!=d.visible&&b.mask==d.draw_layer&&d.render(a,b)},a.prototype.render=function(a){a.flush(),this.draw.clear()},a}(),ShaderProperty=function(){function a(){}return a}(),Shader=function(){function a(a,b){this.attributes=[],this.uniforms=[],this.set(a,b)}return a.prototype.set=function(a,b){this.handle&&this.release(),this.handle=this.link(a,b),this.num_attributes=gl.getProgramParameter(this.handle,gl.ACTIVE_ATTRIBUTES);for(var c=0;c<this.num_attributes;++c){var d=new ShaderProperty;d.value=gl.getActiveAttrib(this.handle,c),d.location=gl.getAttribLocation(this.handle,d.value.name),this.attributes.push(d)}this.num_uniforms=gl.getProgramParameter(this.handle,gl.ACTIVE_UNIFORMS);for(var c=0;c<this.num_uniforms;++c){var d=new ShaderProperty;d.value=gl.getActiveUniform(this.handle,c),d.location=gl.getUniformLocation(this.handle,d.value.name),this.uniforms.push(d)}this.in_use=!1},a.prototype.release=function(){gl.deleteProgram(this.handle),this.attributes=null,this.in_use=!1},a.prototype.compile=function(a,b){var c=gl.createShader(a);gl.shaderSource(c,b),gl.compileShader(c);var d=gl.getShaderParameter(c,gl.COMPILE_STATUS);return d?c:void 0},a.prototype.link=function(a,b){var c=gl.createProgram(),d=this.compile(gl.VERTEX_SHADER,a),e=this.compile(gl.FRAGMENT_SHADER,b);gl.attachShader(c,d),gl.attachShader(c,e),gl.linkProgram(c);var f=gl.getProgramParameter(c,gl.LINK_STATUS);return f?c:void 0},a.prototype.bind=function(){gl.useProgram(this.handle),this.in_use=!0},a.prototype.unbind=function(){0!=this.in_use&&(gl.useProgram(null),this.in_use=!1)},a.prototype.attribute=function(a){return this.bind(),gl.getAttribLocation(this.handle,a)},a.prototype.uniform=function(a){return this.bind(),gl.getUniformLocation(this.handle,a)},a.find=function(a){return onyx.resources.shaders[a]},a}(),Texture=function(){function a(){this.handle=null,this.image=null,this.handle=gl.createTexture()}return a.prototype.release=function(){gl.deleteTexture(this.handle)},a.prototype.bind=function(){gl.bindTexture(gl.TEXTURE_2D,this.handle)},a.prototype.unbind=function(){gl.bindTexture(gl.TEXTURE_2D,null)},a.prototype.set_pixels=function(a,b,c,d){gl.texImage2D(gl.TEXTURE_2D,0,c,a,b,0,c,gl.UNSIGNED_BYTE,d)},a.prototype.set_image=function(a){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a)},a.prototype.set_wrap_mode=function(a,b){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,b)},a.prototype.set_filter=function(a,b){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,b)},a.prototype.create_mipmaps=function(){gl.generateMipmap(gl.TEXTURE_2D)},a.find=function(a){return onyx.resources.textures[a]},a}(),Tween=function(){function a(a,b,c){return this.set(a,b,c),this}return a.prototype.set=function(a,b,c){this.value=0,this.step=1/a,this.loops=b||-1,this.callback=c||null,this.running=!1},a.prototype.start=function(a){return this.value=a||0,this.running=!0,this},a.prototype.pause=function(){this.running=!1},a.prototype.resume=function(){this.running=!0},a.prototype.update=function(a){0!=this.running&&(this.value+=this.step*a,this.value>=1&&(-1==this.loops?this.value=0:this.loops>0?(this.loops--,this.value=0):(this.value=1,this.callback&&this.callback,this.running=!1)))},a}();